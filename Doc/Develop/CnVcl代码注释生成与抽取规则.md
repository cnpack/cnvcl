# CnVcl Pascal 源代码注释生成与抽取规则

本文档用于约束 CnVcl 中 Object Pascal 源文件（.pas/.dpr 等）的注释与排版，以便AI根据该规则生成注释插入源码，并允许文档工具能稳定从源码注释中抽取 API 文档。

## 1. 术语与排版规范（强制）

### 1.1 术语统一

- 注释中涉及“散列/哈希/hash”等概念时，统一使用“杂凑”表述。
- 推荐派生表达：杂凑值、杂凑算法、杂凑校验、杂凑长度等。

### 1.2 中英混排空格

- 注释文本中，ASCII 字母/数字与紧邻汉字之间必须保留 1 个空格。
  - 正例：Base64URL 编码、RFC 2045、P-384 曲线、Win32/Win64
  - 反例：Base64URL编码、RFC2045、P-384曲线

### 1.3 标点与段落

- 建议优先使用中文全角标点（，。；：）组织中文说明。
- 说明段落与“参数/返回值”段落之间保留 1 行空行。

## 2. 可抽取注释块类型（强制）

### 2.1 文档注释块

- 仅抽取 `{* ... }` 形式的注释块作为文档来源。
- `{* ... }` 必须单独成行（不与代码同一行），并紧贴被说明的声明（中间不插入空行或其他注释）。

### 2.2 非文档注释

- `// ...` 与 `{ ... }`（不含 `*`）为实现注释，默认不作为文档抽取来源。

## 3. 文件与单元级注释（建议）

- `unit Xxx;` 后建议紧跟单元说明的文档注释块，用于描述：
  - 单元名称/功能概述
  - 作者与来源信息
  - 平台与兼容性
  - 修改记录（日期、版本、变更摘要）

注意该类注释无需也不能自动生成，需要作者根据实际情况修订

## 4. interface 区域：声明与注释的相对位置（强制）

### 4.1 通用规则

在 interface 中对外可见的声明（const/type/var/resourcestring/函数过程/类方法/属性等），其文档注释必须满足：

- 紧贴声明：文档注释块位于“声明后下一行”，且中间不允许插入空行。
- 独立成行：注释块占用至少独立一行，不和其他内容混成一行，格式为 `{* ... }`。如注释块只有一行，则结尾无需全角句号。

### 4.2 TCn* 类型声明的强制规则

interface 部分每个独立的、以 `TCn` 开头的类型声明，其“名字所在行”的下一行必须写一行独立注释，格式固定为：

```pascal
type
  TCnFoo = class(TObject)
  {* 类型说明}
  ...
```

说明：

- “独立”指该类型在源码中有完整的一段声明（非别名引用或重复声明）。
- 若类型声明跨行，应保证“出现类型名的那一行”的下一行就是 `{* ... }`。

## 5. 常量与资源字符串注释（建议）

### 5.1 const 常量

- 每个对外常量建议在其声明行的下一行添加 `{* ... }` 说明常量含义、取值范围、失败条件等。

示例：

```pascal
const
  ECN_BASE64_OK = ECN_OK;
  {* Base64 系列错误码：无错误值为 0}
```

### 5.2 resourcestring

- 对外资源字符串建议同样用 `{* ... }` 紧贴声明进行说明。

## 6. 函数/过程/构造析构注释块结构（强制）

所有对外 `function/procedure/constructor/destructor` 均必须在声明后添加文档注释块，并按固定结构编写：

1. 功能说明（1 段或多段，注意第二段开始要与第一段的正文对齐，也就是较左花括号缩进三个空格。）
2. 空行
3. “参数”段：逐行列出参数说明，注意每行参数较“参数：”行要缩进两个空格。
4. 空行
5. “返回值”段：说明返回值含义

示例结构：

```pascal
function Foo(const A: Integer; var B: string): Integer;
{* 功能说明第一段。
   功能说明第二段（可选）。

   参数：
     const A: Integer                    - 参数 A 的说明
     var B: string                       - 参数 B 的说明

   返回值：Integer                        - 返回值说明
}
```

另外，constructor 如果没有参数，则使用单行注释{* 构造函数}即可，destructor 的注释则统一使用{* 析构函数}

## 7. 参数与返回值行格式（强制）

### 7.1 参数行格式

- 每个参数单独一行，格式固定为：

`<参数名与类型> - <说明>`

- 参数名前缀 `const/var/out` 必须与函数签名一致，并作为参数名的一部分参与对齐。

### 7.2 返回值行格式

- 必须包含返回值说明行，格式固定为：

`返回值：<类型> - <说明>`

- 对于 `procedure`，返回值行写作：

`返回值：（无）`

### 7.3 减号对齐列（推荐固定列）

为便于文档工具进行稳定解析与视觉对齐，参数与返回值说明行中的 `-` 必须对齐到同一列：

- `-` 位于第 43 列（1-based）。
- 若某行内容较长导致无法在第 43 列放置 `-`，允许后移至 59 列、75 列等，同一注释块内应的 - 号列位置应保持一致。

## 8. 补充约束（建议）

- 对于重载函数（overload），每个重载版本都必须有独立的 `{* ... }` 注释块，不共享注释。
- 对于同名但参数不同的接口，说明应明确指出差异点（输入类型、输出类型等）。
